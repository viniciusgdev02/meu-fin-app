<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIN - Seu Controle Financeiro</title>

    <meta name="theme-color" content="#1e293b"/>
    <link rel="manifest" href="manifest.webmanifest">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIN">
    <link rel="apple-touch-icon" href="icon-192.png"> 
    
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png"> 
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .view { display: none; }
        .view.active { display: block; }
        .nav-item.active svg { color: #3b82f6; }
        .nav-item.active span { color: #3b82f6; }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        /* Estilo para parecer desabilitado */
        select[disabled], input[disabled] {
            background-color: #f1f5f9; /* bg-slate-100 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .dark select[disabled], .dark input[disabled] {
             background-color: #1e293b; /* dark:bg-slate-700 */
        }
        /* Estilo para despesa paga */
        .transaction-paid p:not(.amount-value) { /* N√£o risca o valor */
            text-decoration: line-through;
            opacity: 0.6;
        }
         .transaction-paid .details-text { /* Risca os detalhes */
             text-decoration: line-through;
             opacity: 0.6;
         }

        .transaction-paid .paid-toggle-btn {
             background-color: #10b981; /* bg-emerald-500 */
             color: white;
        }
         .transaction-paid .paid-toggle-btn:hover {
             background-color: #059669; /* hover:bg-emerald-600 */
         }
         
         /* Loading Spinner */
         .loading-spinner {
             border: 3px solid #f3f4f6;
             border-top: 3px solid #3b82f6;
             border-radius: 50%;
             width: 24px;
             height: 24px;
             animation: spin 1s linear infinite;
         }
         @keyframes spin {
             0% { transform: rotate(0deg); }
             100% { transform: rotate(360deg); }
         }
         
         /* Toast notification */
         .toast {
             position: fixed;
             bottom: 80px; /* Ajustado para ficar acima da nav */
             left: 50%;
             transform: translateX(-50%);
             background: #334155; /* dark:bg-slate-700 */
             color: white;
             padding: 12px 24px;
             border-radius: 8px;
             box-shadow: 0 4px 6px rgba(0,0,0,0.3);
             z-index: 1000;
             animation: slideUp 0.3s ease-out;
             opacity: 1;
             transition: opacity 0.5s ease-out;
         }
          .toast.hidden {
             opacity: 0;
             display: none;
         }
         @keyframes slideUp {
             from { transform: translate(-50%, 100px); opacity: 0; }
             to { transform: translate(-50%, 0); opacity: 1; }
         }
         .toast.error {
             background-color: #ef4444; /* bg-red-500 */
         }
         .toast.success {
             background-color: #22c55e; /* bg-green-500 */
         }
         
         /* Search highlight */
         .search-highlight {
             background-color: #fef08a; /* bg-yellow-200 */
             padding: 0 2px;
             border-radius: 2px;
             color: #1e293b; /* text-slate-800 */
         }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="app" class="max-w-lg mx-auto bg-white dark:bg-slate-800 min-h-screen pb-24">
        <header class="p-4 flex items-center justify-between sticky top-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm z-10 border-b border-slate-200 dark:border-slate-700">
            <h1 class="text-2xl font-bold text-blue-500">FIN</h1>
            <h2 id="page-title" class="text-lg font-semibold text-slate-700 dark:text-slate-300">Dashboard</h2>
            <div id="loading-indicator" class="loading-spinner hidden"></div>
        </header>

        <main id="app-content" class="p-4">
            <div id="dashboard-view" class="view active space-y-6">
                <section>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-yellow-50 dark:bg-yellow-900/50 p-4 rounded-lg">
                            <h3 class="text-sm text-yellow-600 dark:text-yellow-400">Saldo (Vale Ref.)</h3>
                            <p id="dashboard-meal-voucher-balance" class="text-xl font-bold text-yellow-700 dark:text-yellow-300">R$ 0,00</p>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/50 p-4 rounded-lg">
                            <h3 class="text-sm text-green-600 dark:text-green-400">Receitas (Outras/M√™s)</h3>
                            <p id="dashboard-other-income" class="text-xl font-bold text-green-700 dark:text-green-300">R$ 0,00</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/50 p-4 rounded-lg col-span-2">
                            <h3 class="text-sm text-red-600 dark:text-red-400">Despesas (M√™s / N√£o pagas)</h3>
                            <p id="dashboard-expense" class="text-2xl font-bold text-red-700 dark:text-red-300">R$ 0,00</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Exclui gastos com Vale Refei√ß√£o</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-blue-50 dark:bg-blue-900/50 p-4 rounded-lg">
                        <h3 class="text-sm text-blue-600 dark:text-blue-400">Saldo (Contas / Realizado)</h3>
                        <p id="dashboard-balance" class="text-3xl font-bold text-blue-700 dark:text-blue-300">R$ 0,00</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Receitas (Outras) - Despesas (Pagas / Exclui VR e Cart√£o)</p>
                    </div>
                </section>

                <section class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg">
                    <h3 class="font-semibold mb-2">Gastos por Categoria (N√£o pagos / Exclui VR)</h3>
                    <div id="chart-container" class="h-64 flex items-center justify-center">
                        <canvas id="expense-chart"></canvas>
                    </div>
                </section>
                
                <section>
                    <h3 class="font-semibold mb-2">Metas em Andamento</h3>
                    <div id="dashboard-goals" class="space-y-3">
                        <p class="text-sm text-slate-500">Nenhuma meta ativa.</p>
                    </div>
                </section>
            </div>

            <div id="transactions-view" class="view">
                <div class="flex justify-center mb-4">
                     <button id="add-transaction-btn" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg w-full">Adicionar Lan√ßamento</button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="search-transactions" placeholder="üîç Buscar por descri√ß√£o..." class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 text-sm">
                </div>
                
                <div class="mb-4 grid grid-cols-3 gap-2">
                    <select id="filter-period" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 text-sm">
                        <option value="month">Este M√™s</option>
                        <option value="last_month">M√™s Anterior</option>
                        <option value="all">Tudo</option>
                    </select>
                     <select id="filter-type" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 text-sm">
                        <option value="all">Todos Tipos</option>
                        <option value="income">Receitas</option>
                        <option value="expense">Despesas</option>
                    </select>
                    <select id="filter-category" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 text-sm">
                        <option value="all">Todas Categorias</option>
                    </select>
                </div>
                
                <div class="mb-4 flex gap-2">
                    <select id="sort-transactions" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 text-sm">
                        <option value="date-desc">Data (Mais recente)</option>
                        <option value="date-asc">Data (Mais antiga)</option>
                        <option value="amount-desc">Valor (Maior)</option>
                        <option value="amount-asc">Valor (Menor)</option>
                    </select>
                </div>
                
                <div id="transactions-list" class="space-y-3"></div>
            </div>

            <div id="cards-view" class="view">
                 <div class="flex justify-center mb-4">
                     <button id="add-card-btn" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg w-full">Adicionar Cart√£o</button>
                </div>
                <div id="cards-list" class="space-y-4"></div>
            </div>

            <div id="goals-view" class="view">
                <div class="flex justify-center mb-4">
                     <button id="add-goal-btn" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg w-full">Criar Nova Meta</button>
                </div>
                <div id="goals-list" class="space-y-4"></div>
            </div>

            <div id="settings-view" class="view space-y-6">
                <section>
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2 dark:border-slate-700">Categorias de Despesa</h3>
                    <div id="expense-categories-list" class="space-y-2 mb-3"></div>
                    <button id="add-expense-category-btn" class="text-sm text-blue-500 font-semibold">+ Adicionar categoria</button>
                </section>
                <section>
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2 dark:border-slate-700">Categorias de Receita</h3>
                    <div id="income-categories-list" class="space-y-2 mb-3"></div>
                    <button id="add-income-category-btn" class="text-sm text-blue-500 font-semibold">+ Adicionar categoria</button>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2 dark:border-slate-700">Backup de Dados</h3>
                    <div class="space-y-2">
                        <button id="export-data-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg w-full">üì• Exportar Dados (JSON)</button>
                        <button id="import-data-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg w-full">üì§ Importar Dados (JSON)</button>
                        <input type="file" id="import-file-input" accept=".json" class="hidden">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">‚ö†Ô∏è Dados salvos apenas neste dispositivo</p>
                    </div>
                </section>
                
                <section>
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2 dark:border-slate-700">Relat√≥rios Mensais</h3>
                    <div class="flex gap-2 mb-4">
                        <select id="report-month" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 text-sm"></select>
                        <select id="report-year" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 text-sm"></select>
                    </div>
                    <button id="generate-report-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg w-full">Gerar Relat√≥rio</button>
                    <div id="report-output" class="mt-4 bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg hidden"></div>
                </section>
            </div>
        </main>
        
        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex justify-around p-2">
            <button data-view="dashboard-view" class="nav-item flex flex-col items-center text-slate-500 active" aria-label="Ir para Dashboard">
                <i data-lucide="layout-dashboard" aria-hidden="true"></i><span class="text-xs">Dashboard</span>
            </button>
            <button data-view="transactions-view" class="nav-item flex flex-col items-center text-slate-500" aria-label="Ir para Lan√ßamentos">
                <i data-lucide="arrow-left-right" aria-hidden="true"></i><span class="text-xs">Lan√ßamentos</span>
            </button>
            <button data-view="cards-view" class="nav-item flex flex-col items-center text-slate-500" aria-label="Ir para Cart√µes">
                <i data-lucide="credit-card" aria-hidden="true"></i><span class="text-xs">Cart√µes</span>
            </button>
            <button data-view="goals-view" class="nav-item flex flex-col items-center text-slate-500" aria-label="Ir para Metas">
                <i data-lucide="target" aria-hidden="true"></i><span class="text-xs">Metas</span>
            </button>
            <button data-view="settings-view" class="nav-item flex flex-col items-center text-slate-500" aria-label="Ir para Ajustes">
                <i data-lucide="settings" aria-hidden="true"></i><span class="text-xs">Ajustes</span>
            </button>
        </nav>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-lg max-h-[90vh] overflow-y-auto">
            </div>
    </div>


    <script>
    
    // Inicia o Service Worker para PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => console.log('ServiceWorker registrado com sucesso:', registration.scope))
                .catch(error => console.log('Falha ao registrar ServiceWorker:', error));
        });
    }
    

    document.addEventListener('DOMContentLoaded', () => {
        
        // Inicializa√ß√£o dos √≠cones
        lucide.createIcons();

        // =================================================================================
        // L√ìGICA DA APLICA√á√ÉO (FIN App)
        // =================================================================================
        window.App = {
            data: {
                transactions: [],
                cards: [],
                goals: [],
                categories: {
                    income: [
                        { id: '1', name: 'Sal√°rio' },
                        { id: '2', name: 'Freelance' },
                        { id: '100', name: 'Vale Refei√ß√£o' } // Categoria padr√£o
                    ],
                    // ### MODIFICADO 1: Adiciona cores padr√£o
                    expense: [
                        { id: '0', name: 'Sem Categoria', color: '#9ca3af' }, // Categoria padr√£o
                        { id: '1', name: 'Alimenta√ß√£o', color: '#ef4444' },
                        { id: '2', name: 'Transporte', color: '#f97316' },
                        { id: '3', name: 'Moradia', color: '#eab308' },
                        { id: '4', name: 'Lazer', color: '#84cc16' },
                    ]
                },
                 mealVoucherBalance: 0
            },
            
            // Fun√ß√£o de Inicializa√ß√£o
            init() {
                this.loadData();
                this.calculateMealVoucherBalance();
                this.generateRecurringTransactions();
                this.setupEventListeners();
                this.loadFilterPreferences(); 
                this.navigateTo('dashboard-view');
                this.checkStorageLimit();
            },

            // Carrega os dados do localStorage
            loadData() {
                const savedData = localStorage.getItem('fin-app-data');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        this.data = {
                            transactions: parsedData.transactions || [],
                            cards: parsedData.cards || [],
                            goals: parsedData.goals || [],
                            categories: {
                                income: parsedData.categories?.income || this.data.categories.income,
                                expense: parsedData.categories?.expense || this.data.categories.expense
                            },
                            mealVoucherBalance: parsedData.mealVoucherBalance || 0,
                        };
                        
                        // Garante categorias padr√£o
                        if (!this.data.categories.income.some(c => c.id === '100')) {
                            this.data.categories.income.push({ id: '100', name: 'Vale Refei√ß√£o' });
                        }
                        if (!this.data.categories.expense.some(c => c.id === '0')) {
                            this.data.categories.expense.unshift({ id: '0', name: 'Sem Categoria', color: '#9ca3af' });
                        }
                        
                        // Migra√ß√£o e valida√ß√£o de dados
                        this.data.transactions.forEach(t => {
                            if (t.type === 'expense' && typeof t.paid !== 'boolean') t.paid = false;
                            if (typeof t.isFixed !== 'boolean') t.isFixed = false;
                            if (t.isFixed && !t.originalDate) t.originalDate = t.date;
                            if (t.isFixed && !t.fixedSourceId) t.fixedSourceId = t.id;
                            if (t.type === 'expense' && !t.paymentMethod) {
                                t.paymentMethod = t.cardId ? 'card' : 'account';
                            }
                            if (t.categoryId === undefined || t.categoryId === null) {
                                t.categoryId = '0';
                            }
                            // Garante IDs como string
                            t.id = String(t.id);
                            if (t.cardId) t.cardId = String(t.cardId);
                            t.categoryId = String(t.categoryId);
                            if (t.fixedSourceId) t.fixedSourceId = String(t.fixedSourceId);
                            if (t.purchaseId) t.purchaseId = String(t.purchaseId);
                        });
                         this.data.cards.forEach(c => { c.id = String(c.id); });
                         this.data.goals.forEach(g => { g.id = String(g.id); });
                         
                         // ### MODIFICADO 2: Migra√ß√£o de cores para dados antigos
                         const defaultColors = {
                             '0': '#9ca3af',
                             '1': '#ef4444',
                             '2': '#f97316',
                             '3': '#eab308',
                             '4': '#84cc16'
                         };
                         this.data.categories.expense.forEach(c => { 
                             c.id = String(c.id);
                             if (!c.color) {
                                 // Se a categoria n√£o tiver cor (dados antigos), atribui uma
                                 c.color = defaultColors[c.id] || '#84cc16'; // Padr√£o verde para novas
                             }
                         });
                         this.data.categories.income.forEach(c => { c.id = String(c.id); });

                        
                        this.calculateMealVoucherBalance();
                    } catch(e) {
                        console.error('Erro ao carregar dados:', e);
                        this.showToast('Erro ao carregar dados salvos', 'error');
                        localStorage.removeItem('fin-app-data');
                    }
                }
            },

             // Calculate and store VR balance
             calculateMealVoucherBalance() {
                 const mealVoucherCategoryId = '100';
                 const totalVRIncome = this.data.transactions
                     .filter(t => t.type === 'income' && t.categoryId === mealVoucherCategoryId)
                     .reduce((sum, t) => sum + t.amount, 0);

                 const totalVRExpense = this.data.transactions
                     .filter(t => t.type === 'expense' && t.paymentMethod === 'meal_voucher' && t.paid === true)
                     .reduce((sum, t) => sum + t.amount, 0);

                 this.data.mealVoucherBalance = totalVRIncome - totalVRExpense;
             },

            // Salva os dados no localStorage
            saveData(refresh = true) { 
                 this.showLoading(true);
                 this.calculateMealVoucherBalance();
                 
                try {
                    localStorage.setItem('fin-app-data', JSON.stringify(this.data));
                     if(refresh){
                        this.refreshUI();
                     }
                     this.checkStorageLimit();
                } catch(e) {
                    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                        this.showToast('‚ö†Ô∏è Limite de armazenamento atingido! Exporte seus dados.', 'error');
                    } else {
                        this.showToast('Erro ao salvar dados', 'error');
                        console.error('Erro ao salvar:', e.name, e.message);
                    }
                } finally {
                     setTimeout(() => {
                        this.showLoading(false);
                     }, 200);
                }
            },

            // Fun√ß√µes de Feedback (Loading e Toast)
            showLoading(show) {
                const indicator = document.getElementById('loading-indicator');
                if (indicator) {
                    indicator.classList.toggle('hidden', !show);
                }
            },

            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) existingToast.remove();

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            },
            
             checkStorageLimit() {
                try {
                    const data = JSON.stringify(this.data);
                    const sizeInBytes = new Blob([data]).size;
                    const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                    const limitKB = 5120;
                    const percentUsed = ((sizeInKB / limitKB) * 100).toFixed(1);
                    
                    if (percentUsed > 90) {
                         console.warn(`‚ö†Ô∏è ATEN√á√ÉO ARMAZENAMENTO: ${sizeInKB}KB / ${limitKB}KB (${percentUsed}%)`);
                         this.showToast(`Armazenamento quase cheio (${percentUsed}%). Considere exportar seus dados.`, 'error');
                    } else if (percentUsed > 75) {
                         console.log(`Armazenamento: ${sizeInKB}KB / ${limitKB}KB (${percentUsed}%)`);
                    }
                } catch(e) {
                    // Pode falhar
                }
            },

            // Navega√ß√£o entre abas
            navigateTo(viewId) {
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');

                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`.nav-item[data-view="${viewId}"]`).classList.add('active');

                const titles = {
                    'dashboard-view': 'Dashboard',
                    'transactions-view': 'Lan√ßamentos',
                    'cards-view': 'Cart√µes de Cr√©dito',
                    'goals-view': 'Metas Financeiras',
                    'settings-view': 'Ajustes e Relat√≥rios'
                };
                document.getElementById('page-title').textContent = titles[viewId];
                
                this.refreshUI(viewId);
            },
            
            // Atualiza a UI com base na view ativa
            refreshUI(viewId) {
                const currentView = viewId || document.querySelector('.view.active').id;

                switch (currentView) {
                    case 'dashboard-view':
                        this.renderDashboard();
                        break;
                    case 'transactions-view':
                        this.renderTransactions();
                        break;
                    case 'cards-view':
                        this.renderCards();
                        break;
                    case 'goals-view':
                        this.renderGoals();
                        break;
                    case 'settings-view':
                        this.renderSettings();
                        break;
                }
                lucide.createIcons();
            },

            // Configura√ß√£o de Eventos
            setupEventListeners() {
                document.querySelectorAll('.nav-item').forEach(button => {
                    button.addEventListener('click', () => {
                        this.navigateTo(button.dataset.view);
                    });
                });

                document.getElementById('add-transaction-btn').addEventListener('click', () => this.showTransactionModal());
                document.getElementById('add-card-btn').addEventListener('click', () => this.showCardModal());
                document.getElementById('add-goal-btn').addEventListener('click', () => this.showGoalModal());
                document.getElementById('add-expense-category-btn').addEventListener('click', () => this.showCategoryModal('expense'));
                document.getElementById('add-income-category-btn').addEventListener('click', () => this.showCategoryModal('income'));

                const applyFilters = () => {
                    this.saveFilterPreferences(); 
                    this.renderTransactions();
                };
                document.getElementById('filter-period').addEventListener('change', applyFilters);
                document.getElementById('filter-type').addEventListener('change', applyFilters); 
                document.getElementById('filter-category').addEventListener('change', applyFilters);
                document.getElementById('search-transactions').addEventListener('input', () => this.renderTransactions());
                document.getElementById('sort-transactions').addEventListener('change', applyFilters);

                document.getElementById('generate-report-btn').addEventListener('click', () => this.renderReport());
                
                document.getElementById('export-data-btn').addEventListener('click', () => this.exportData());
                document.getElementById('import-data-btn').addEventListener('click', () => {
                     document.getElementById('import-file-input').click();
                });
                document.getElementById('import-file-input').addEventListener('change', (e) => this.importData(e));
            },
            
            saveFilterPreferences() {
                 const prefs = {
                    period: document.getElementById('filter-period').value,
                    type: document.getElementById('filter-type').value,
                    category: document.getElementById('filter-category').value,
                    sort: document.getElementById('sort-transactions').value
                 };
                 sessionStorage.setItem('fin-filter-prefs', JSON.stringify(prefs));
            },
            
             loadFilterPreferences() {
                const saved = sessionStorage.getItem('fin-filter-prefs');
                if (saved) {
                    try {
                        const prefs = JSON.parse(saved);
                        document.getElementById('filter-period').value = prefs.period || 'month';
                        document.getElementById('filter-type').value = prefs.type || 'all';
                        document.getElementById('sort-transactions').value = prefs.sort || 'date-desc';
                    } catch (e) {
                         console.error("Erro ao carregar filtros:", e);
                         sessionStorage.removeItem('fin-filter-prefs');
                    }
                }
            },

            // Fun√ß√µes de Renderiza√ß√£o
            renderDashboard() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const mealVoucherCategoryId = '100';

                const monthlyTransactions = this.data.transactions.filter(t => {
                     const date = new Date(t.date);
                     // Adiciona tratamento para datas inv√°lidas (caso existam nos dados salvos)
                     if (isNaN(date.getTime())) return false; 
                     return date.getUTCMonth() === currentMonth && date.getUTCFullYear() === currentYear;
                });

                const monthlyOtherIncome = monthlyTransactions
                    .filter(t => t.type === 'income' && t.categoryId !== mealVoucherCategoryId)
                    .reduce((sum, t) => sum + t.amount, 0);

                const monthlyUnpaidExpense = monthlyTransactions
                    .filter(t => t.type === 'expense' && !t.paid && t.paymentMethod !== 'meal_voucher')
                    .reduce((sum, t) => sum + t.amount, 0);

                 const paidNonCardNonVRExpenses = monthlyTransactions
                    .filter(t => t.type === 'expense' && !t.cardId && t.paymentMethod !== 'meal_voucher' && t.paid === true)
                    .reduce((sum, t) => sum + t.amount, 0);

                const balance = monthlyOtherIncome - paidNonCardNonVRExpenses;

                 document.getElementById('dashboard-meal-voucher-balance').textContent = this.formatCurrency(this.data.mealVoucherBalance);
                document.getElementById('dashboard-other-income').textContent = this.formatCurrency(monthlyOtherIncome);
                document.getElementById('dashboard-expense').textContent = this.formatCurrency(monthlyUnpaidExpense);
                document.getElementById('dashboard-balance').textContent = this.formatCurrency(balance);
                document.getElementById('dashboard-balance').classList.toggle('text-red-700', balance < 0);
                document.getElementById('dashboard-balance').classList.toggle('dark:text-red-300', balance < 0);

                const goalsContainer = document.getElementById('dashboard-goals');
                const activeGoals = this.data.goals.filter(g => g.saved < g.target).slice(0, 3);
                if (activeGoals.length > 0) {
                    goalsContainer.innerHTML = activeGoals.map(goal => this.getGoalHTML(goal)).join('');
                } else {
                    goalsContainer.innerHTML = `<p class="text-sm text-slate-500 dark:text-slate-400">Nenhuma meta em andamento.</p>`;
                }

                this.renderExpenseChart(currentMonth, currentYear);
            },

            // ### MODIFICADO 5: Atualiza renderiza√ß√£o do gr√°fico
            renderExpenseChart(month, year) {
                const chartContainer = document.getElementById('chart-container');
                const chartCanvas = document.getElementById('expense-chart');
                
                chartContainer.innerHTML = '<canvas id="expense-chart"></canvas>';
                const newChartCanvas = document.getElementById('expense-chart');

                const expenseData = this.data.transactions
                    .filter(t => {
                         const date = new Date(t.date);
                         if (isNaN(date.getTime())) return false; 
                         return t.type === 'expense' && 
                                !t.paid && 
                                t.paymentMethod !== 'meal_voucher' &&
                                date.getUTCMonth() === month && 
                                date.getUTCFullYear() === year;
                    });

                const expenseByCat = expenseData.reduce((acc, t) => {
                    const category = this.getCategoryById('expense', t.categoryId);
                    const categoryName = category ? category.name : 'Sem Categoria';
                    acc[categoryName] = (acc[categoryName] || 0) + t.amount;
                    return acc;
                }, {});

                if (window.expenseChart instanceof Chart) {
                    window.expenseChart.destroy();
                }

                if (Object.keys(expenseByCat).length === 0) {
                    chartContainer.innerHTML = `<p class="text-sm text-center text-slate-500">Sem despesas (n√£o pagas / exclui VR) este m√™s para exibir.</p>`;
                    return;
                }

                // --- IN√çCIO DA L√ìGICA DE CORES DIN√ÇMICAS ---
                const chartLabels = Object.keys(expenseByCat);
                const chartData = Object.values(expenseByCat);

                // Mapeia os nomes das categorias (labels) para suas cores salvas
                const chartColors = chartLabels.map(labelName => {
                    const category = this.data.categories.expense.find(c => c.name === labelName);
                    // Retorna a cor da categoria ou uma cor cinza padr√£o
                    return category?.color || '#9ca3af'; 
                });
                // --- FIM DA L√ìGICA DE CORES ---


                window.expenseChart = new Chart(newChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels, // Modificado
                        datasets: [{
                            data: chartData, // Modificado
                            backgroundColor: chartColors, // Modificado
                            borderWidth: 0,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: document.body.classList.contains('dark') ? '#cbd5e1' : '#475569',
                                }
                            }
                        }
                    }
                });
            },

            getGoalHTML(goal) {
                const progress = (goal.target > 0) ? Math.min(100, (goal.saved / goal.target) * 100) : 0;
                
                return `
                <div class="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-sm">${goal.name}</span>
                        <span class="text-xs font-medium">${this.formatCurrency(goal.saved)} / ${this.formatCurrency(goal.target)}</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                        <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            },

            // M√©todos de ajuda (helpers)
            formatCurrency(value) {
                if (typeof value !== 'number') value = 0;
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            },

            autoFormatCurrency(input) {
                let rawValue = input.value;
                let isNegative = rawValue.startsWith('-');
                
                let value = rawValue.replace(/\D/g, '');
                if (value === '') {
                    input.value = '';
                    return;
                }
                
                value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                input.value = (isNegative ? '-' : '') + 'R$ ' + value;
            },

            parseCurrency(value) {
                if (typeof value !== 'string') return 0;
                return parseFloat(value.replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.')) || 0;
            },
            
            getCategoryById(type, id) {
                return this.data.categories[type].find(c => c.id === id);
            },
            
            getCardById(id) {
                return this.data.cards.find(c => c.id === id);
            },
            
            // Corrige data para o fuso UTC (evita bugs de "dia anterior")
            getUTCDate(dateString) {
                const date = new Date(dateString + 'T00:00:00'); // Assume 00:00 no fuso local
                return new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            },

             // Retorna YYYY-MM-DD
            getISODate(date) {
                return date.toISOString().split('T')[0];
            },
            
            // Calcula a pr√≥xima data de vencimento
            getNextDueDate(day, month, year) {
                const lastDayOfTargetMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                const targetDay = Math.min(day, lastDayOfTargetMonth);
                const finalDate = new Date(Date.UTC(year, month, targetDay));
                return finalDate.toISOString().split('T')[0];
            },

            showModal(content) {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = content;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                const closeModal = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modal.removeEventListener('click', handleOutsideClick);
                };
                
                const handleOutsideClick = (e) => {
                    if (e.target.id === 'modal') closeModal();
                };

                modal.addEventListener('click', handleOutsideClick);
                modal.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeModal));
                
                lucide.createIcons();
            },
            
            getNewId() {
                return Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 9);
            },
            
            // CORRE√á√ÉO: Fun√ß√£o para validar data YYYY-MM-DD
            isValidDate(dateString) {
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                // Verifica se a data criada corresponde aos valores de entrada
                return date.getUTCFullYear() === year &&
                       date.getUTCMonth() === month - 1 &&
                       date.getUTCDate() === day;
            },

            // =================================================================================
            // Se√ß√£o: Lan√ßamentos (Transactions)
            // =================================================================================
            
            renderTransactions() {
                const savedPrefs = JSON.parse(sessionStorage.getItem('fin-filter-prefs'));
                this.updateFilterCategories();
                
                 if(savedPrefs) {
                    document.getElementById('filter-period').value = savedPrefs.period || 'month';
                    document.getElementById('filter-type').value = savedPrefs.type || 'all';
                    document.getElementById('filter-category').value = savedPrefs.category || 'all';
                    document.getElementById('sort-transactions').value = savedPrefs.sort || 'date-desc';
                 }
                
                const listEl = document.getElementById('transactions-list');
                const filteredTransactions = this.getFilteredTransactions();

                if (filteredTransactions.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-sm text-slate-500 dark:text-slate-400 py-8">Nenhum lan√ßamento encontrado.</p>`;
                    return;
                }
                
                const searchTerm = document.getElementById('search-transactions').value.toLowerCase();
                const highlightText = (text, term) => {
                    if (!term) return text;
                    const regex = new RegExp(`(${term})`, 'gi');
                    return text.replace(regex, '<span class="search-highlight">$1</span>');
                };

                listEl.innerHTML = filteredTransactions.map(t => {
                    const isIncome = t.type === 'income';
                    const isExpense = t.type === 'expense';
                    const isPaid = isExpense && t.paid;
                    const isFixed = t.isFixed;
                    const isGeneratedFixed = isFixed && t.fixedSourceId !== t.id;
                    const category = this.getCategoryById(t.type, t.categoryId);
                    
                    let dateStr = 'Data Inv√°lida';
                    if (this.isValidDate(t.date)) {
                        const dateObj = this.getUTCDate(t.date);
                        dateStr = dateObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    }

                    let details = `${dateStr} | ${category ? category.name : 'Sem Categoria'}`;
                    
                    if (isExpense) {
                        if (t.paymentMethod === 'meal_voucher') {
                            details += ' (VR)';
                        } else if (t.cardId) {
                            const card = this.getCardById(t.cardId);
                            details += ` (${card ? card.name : 'Cart√£o'})`;
                            if (t.installments) {
                                details += ` ${t.installments.current}/${t.installments.total}`;
                            }
                        }
                    }

                    const paidButtonHTML = isExpense ? `
                        <button 
                            onclick="App.toggleTransactionPaid('${t.id}')" 
                            class="paid-toggle-btn text-xs font-semibold py-1 px-3 rounded-lg flex items-center gap-1 ${isPaid ? 'bg-emerald-500 text-white hover:bg-emerald-600' : 'bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500'}">
                            <i data-lucide="${isPaid ? 'check-circle' : 'circle'}" class="w-4 h-4"></i>
                            <span>${isPaid ? 'Pago' : 'Pagar'}</span>
                        </button>
                    ` : '';
                    
                    const fixedIconHTML = isFixed ? `<i data-lucide="repeat" class="w-3 h-3 ${isGeneratedFixed ? 'text-gray-400' : 'text-blue-500'} ml-1 inline-block" title="${isGeneratedFixed ? 'Lan√ßamento Fixo (Gerado)' : 'Lan√ßamento Fixo (Original)'}"></i>` : '';

                    return `
                    <div class="transaction-item flex items-center justify-between bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg ${isPaid ? 'transaction-paid' : ''}">
                        <div class="flex-1 min-w-0 mr-2 cursor-pointer" onclick="App.showTransactionModal('${t.id}')">
                            <p class="font-semibold truncate">${highlightText(t.description, searchTerm)}${fixedIconHTML}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400 truncate details-text">${details}</p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${paidButtonHTML}
                            <p class="font-bold text-right amount-value ${isIncome ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                ${isIncome ? '+' : '-'} ${this.formatCurrency(t.amount)}
                            </p>
                        </div>
                    </div>
                    `;
                }).join('');
                
                lucide.createIcons();
            },
            
            updateFilterCategories() {
                const typeFilter = document.getElementById('filter-type').value;
                const catSelect = document.getElementById('filter-category');
                const currentCat = catSelect.value;
                
                let categories = [];
                if (typeFilter === 'all') {
                    categories = [...this.data.categories.income, ...this.data.categories.expense];
                } else {
                    categories = this.data.categories[typeFilter];
                }
                
                categories = categories.filter(c => c.id !== '0' && c.id !== '100'); // Remove padr√µes
                categories.sort((a, b) => a.name.localeCompare(b.name));
                
                catSelect.innerHTML = '<option value="all">Todas Categorias</option>';
                catSelect.innerHTML += '<option value="0">Sem Categoria</option>';
                if(typeFilter === 'all' || typeFilter === 'income') {
                     catSelect.innerHTML += '<option value="100">Vale Refei√ß√£o</option>';
                }
                
                catSelect.innerHTML += categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                
                catSelect.value = currentCat;
            },

            getFilteredTransactions() {
                let transactions = [...this.data.transactions];
                const period = document.getElementById('filter-period').value;
                const typeFilter = document.getElementById('filter-type').value;
                const categoryId = document.getElementById('filter-category').value;
                const searchTerm = document.getElementById('search-transactions').value.toLowerCase();
                const sortOption = document.getElementById('sort-transactions').value;

                if (period === 'month' || period === 'last_month') {
                    const now = new Date();
                    let month = now.getMonth();
                    let year = now.getFullYear();
                    
                    if (period === 'last_month') {
                        if (month === 0) {
                            month = 11;
                            year--;
                        } else {
                            month--;
                        }
                    }

                    transactions = transactions.filter(t => {
                         const date = new Date(t.date);
                         if (isNaN(date.getTime())) return false; 
                         return date.getUTCMonth() === month && date.getUTCFullYear() === year;
                    });
                }
                
                if (typeFilter !== 'all') {
                    transactions = transactions.filter(t => t.type === typeFilter);
                }
                
                if (categoryId !== 'all') {
                    transactions = transactions.filter(t => t.categoryId === categoryId);
                }
                
                if (searchTerm) {
                    transactions = transactions.filter(t => t.description.toLowerCase().includes(searchTerm));
                }

                transactions.sort((a, b) => {
                    // Trata datas inv√°lidas na ordena√ß√£o
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (isNaN(dateA.getTime())) return 1;
                    if (isNaN(dateB.getTime())) return -1;
                    
                    switch(sortOption) {
                        case 'date-asc': return dateA - dateB;
                        case 'amount-desc': return b.amount - a.amount;
                        case 'amount-asc': return a.amount - b.amount;
                        case 'date-desc':
                        default: return dateB - dateA;
                    }
                });

                return transactions;
            },

            showTransactionModal(id) {
                const transaction = id ? this.data.transactions.find(t => t.id === id) : null;
                const isEditing = !!transaction;
                const isGeneratedFixed = isEditing && transaction.isFixed && transaction.fixedSourceId && transaction.fixedSourceId !== transaction.id;
                
                const type = transaction?.type || 'expense';
                const isFixed = transaction?.isFixed || false;

                let currentPaymentMethod = 'account';
                if (isEditing && transaction.type === 'expense') {
                    if (transaction.paymentMethod === 'meal_voucher') {
                        currentPaymentMethod = 'meal_voucher';
                    } else if (transaction.cardId) {
                        currentPaymentMethod = transaction.cardId.toString();
                    }
                }

                const getCategoryOptions = (type) => this.data.categories[type]
                    .sort((a,b) => a.name.localeCompare(b.name))
                    .filter(c => !(type === 'expense' && c.id === '100')) // N√£o deixa usar VR em despesa
                    .map(c => `<option value="${c.id}" ${transaction?.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`)
                    .join('');

                const getPaymentOptions = () => {
                    let options = `<option value="account" ${currentPaymentMethod === 'account' ? 'selected' : ''}>Conta (Saldo)</option>`;
                    options += `<option value="meal_voucher" ${currentPaymentMethod === 'meal_voucher' ? 'selected' : ''}>Vale Refei√ß√£o</option>`;
                    
                    this.data.cards.forEach(card => {
                        options += `<option value="${card.id}" ${currentPaymentMethod === card.id ? 'selected' : ''}>${card.name}</option>`;
                    });
                    return options;
                };

                // Tenta pegar a data de hoje no fuso local e converter para YYYY-MM-DD
                let inputDate = transaction?.date || new Date().toISOString().split('T')[0];
                if (this.isValidDate(inputDate) === false) {
                     inputDate = new Date().toISOString().split('T')[0];
                }

                const modalHTML = `
                <form id="transaction-form" class="space-y-4">
                    <div class="flex items-center justify-between">
                         <h3 class="text-xl font-bold">${isEditing ? 'Editar' : 'Novo'} Lan√ßamento</h3>
                         <button type="button" class="close-modal-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" data-type="expense" class="tab-button border dark:border-slate-600 p-2 rounded-md text-sm font-semibold ${type === 'expense' ? 'active' : ''}">Despesa</button>
                        <button type="button" data-type="income" class="tab-button border dark:border-slate-600 p-2 rounded-md text-sm font-semibold ${type === 'income' ? 'active' : ''}">Receita</button>
                    </div>
                    
                    <input type="hidden" name="id" value="${transaction?.id || ''}">
                    <input type="hidden" name="type" value="${type}">
                    
                    ${isGeneratedFixed ? '<p class="text-xs text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/50 p-2 rounded">Editando um lan√ßamento fixo gerado. Apenas Descri√ß√£o, Categoria e Data (dentro do m√™s) podem ser alterados. Para mudar valor ou recorr√™ncia, edite o lan√ßamento original.</p>' : ''}

                    <div>
                        <label class="text-sm font-medium">Valor</label>
                        <input type="text" name="amount" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${this.formatCurrency(transaction?.amount)}" oninput="App.autoFormatCurrency(this)" ${isGeneratedFixed ? 'disabled' : ''} required>
                    </div>
                     <div>
                        <label class="text-sm font-medium">Descri√ß√£o</label>
                        <input type="text" name="description" maxlength="100" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${transaction?.description || ''}" required>
                    </div>
                     <div>
                        <label class="text-sm font-medium">Data</label>
                        <input type="date" name="date" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${inputDate}" required>
                        ${isGeneratedFixed ? '<p class="text-xs text-slate-400 mt-1">Apenas o dia pode ser alterado dentro do m√™s atual.</p>' : ''}
                    </div>
                     <div>
                        <label class="text-sm font-medium">Categoria</label>
                        <select id="category-select" name="categoryId" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                            ${getCategoryOptions(type)}
                        </select>
                    </div>
                    
                    <div id="expense-options" class="space-y-4">
                        <div>
                            <label class="text-sm font-medium">Forma de Pagamento</label>
                            <select id="payment-method-select" name="paymentMethod" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" ${isGeneratedFixed ? 'disabled' : ''}>
                                ${getPaymentOptions()}
                            </select>
                        </div>
                         <div id="installments-option" class="hidden">
                            <label class="text-sm font-medium">Parcelas</label>
                            <input type="number" name="installments" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${transaction?.installments?.total || 1}" min="1" max="48" ${isGeneratedFixed ? 'disabled' : ''}>
                        </div>
                    </div>

                    <div class="pt-2">
                        <label class="flex items-center gap-2" for="is-fixed-checkbox">
                            <input type="checkbox" id="is-fixed-checkbox" name="isFixed" class="h-4 w-4 rounded" ${isFixed ? 'checked' : ''} ${isGeneratedFixed ? 'disabled' : ''}>
                            <span class="text-sm font-medium">${type === 'expense' ? 'Despesa Fixa?' : 'Receita Fixa?'}</span>
                        </label>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Lan√ßamento ser√° recriado todo m√™s nesta data.</p>
                    </div>

                    <div class="flex gap-2 pt-4">
                        ${isEditing ? `<button type="button" onclick="App.deleteTransaction('${transaction.id}')" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg">Excluir</button>` : ''}
                        <button type="submit" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex-1">Salvar</button>
                    </div>
                </form>
                `;
                
                this.showModal(modalHTML);

                const form = document.getElementById('transaction-form');
                const paymentSelect = document.getElementById('payment-method-select');
                const installmentsDiv = document.getElementById('installments-option');

                const toggleOptionsVisibility = (type) => {
                    const expenseOptions = document.getElementById('expense-options');
                    expenseOptions.style.display = type === 'expense' ? 'block' : 'none';
                    toggleInstallments();
                };

                const toggleInstallments = () => {
                    const selectedValue = paymentSelect.value;
                    const isCard = selectedValue !== 'account' && selectedValue !== 'meal_voucher';
                    installmentsDiv.style.display = isCard ? 'block' : 'none';
                    if (!isCard) {
                         form.elements.installments.value = 1;
                    }
                };

                paymentSelect.addEventListener('change', toggleInstallments);
                
                form.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const newType = e.target.dataset.type;
                        form.elements.type.value = newType;
                        
                        form.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        form.querySelector('#category-select').innerHTML = getCategoryOptions(newType);
                        form.querySelector('label[for="is-fixed-checkbox"]').textContent = (newType === 'expense') ? 'Despesa Fixa?' : 'Receita Fixa?';
                        
                        toggleOptionsVisibility(newType);
                    });
                });

                toggleOptionsVisibility(type);

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveTransaction(new FormData(form));
                    document.getElementById('modal').click();
                });
            },
            
            saveTransaction(formData) {
                const id = formData.get('id') || null;
                const type = formData.get('type');
                const amount = this.parseCurrency(formData.get('amount'));
                const description = formData.get('description');
                const date = formData.get('date');
                const categoryId = formData.get('categoryId');
                const isFixed = formData.get('isFixed') === 'on';

                if (amount <= 0) {
                    this.showToast('O valor deve ser maior que zero', 'error');
                    return;
                }
                
                // CORRE√á√ÉO: Valida√ß√£o de data inv√°lida
                if (!this.isValidDate(date)) {
                     this.showToast('Data inv√°lida', 'error');
                     return;
                }
                
                let paymentMethod = 'account';
                let cardId = null;
                let installments = 1;

                if (type === 'expense') {
                    const paymentValue = formData.get('paymentMethod');
                    if (paymentValue === 'account') {
                        paymentMethod = 'account';
                    } else if (paymentValue === 'meal_voucher') {
                        paymentMethod = 'meal_voucher';
                    } else {
                        paymentMethod = 'card';
                        cardId = paymentValue;
                        installments = parseInt(formData.get('installments')) || 1;
                    }
                }

                if (id) {
                    // Editando
                    const transaction = this.data.transactions.find(t => t.id === id);
                    if (!transaction) return;
                    
                    const isGeneratedFixed = transaction.isFixed && transaction.fixedSourceId && transaction.fixedSourceId !== transaction.id;

                    if (isGeneratedFixed) {
                         // Editando lan√ßamento gerado (limitado)
                         transaction.description = description;
                         transaction.categoryId = categoryId;
                         
                         // S√≥ permite alterar o dia, dentro do m√™s original
                         const originalDate = new Date(transaction.date);
                         const newDate = new Date(date);
                         
                         if(newDate.getUTCMonth() === originalDate.getUTCMonth() && newDate.getUTCFullYear() === originalDate.getUTCFullYear()) {
                            transaction.date = date;
                         } else {
                             this.showToast('Data de lan√ßamento fixo s√≥ pode ser alterada dentro do m√™s.', 'error');
                         }
                    
                    } else {
                         // Editando lan√ßamento normal ou original
                         const oldInstallments = transaction.installments;
                         const oldPurchaseId = transaction.purchaseId;
                         
                         // Se era parcelado e deixou de ser, ou mudou o valor
                         if (oldPurchaseId && (installments === 1 || amount !== transaction.amount)) {
                             // Excluir todas as parcelas antigas
                              this.data.transactions = this.data.transactions.filter(t => t.purchaseId !== oldPurchaseId);
                         }
                         
                         // Se era fixo e deixou de ser
                         if(transaction.isFixed && !isFixed) {
                             // Remove futuros gerados
                             this.data.transactions = this.data.transactions.filter(t => t.fixedSourceId !== transaction.id || t.id === transaction.id);
                         }
                         
                         // Se era parcelado, apaga e recria
                         if (oldPurchaseId && installments > 1) {
                             this.createInstallments(type, amount, description, date, categoryId, cardId, installments);
                         
                         } else if (installments > 1) {
                             // Era normal e virou parcelado
                             this.createInstallments(type, amount, description, date, categoryId, cardId, installments);
                             // Remove o original que serviu de base (se n√£o for o mesmo ID)
                             if(transaction.id !== id) {
                                  this.data.transactions = this.data.transactions.filter(t => t.id !== id);
                             }

                         } else {
                             // Atualiza√ß√£o simples
                             Object.assign(transaction, {
                                 type, amount, description, date, categoryId, isFixed, paymentMethod, cardId,
                                 originalDate: isFixed ? (transaction.originalDate || date) : null,
                                 fixedSourceId: isFixed ? (transaction.fixedSourceId || id) : null,
                                 installments: null,
                                 purchaseId: null
                             });
                         }
                    }

                } else {
                    // Novo Lan√ßamento
                    if (installments > 1 && type === 'expense' && cardId) {
                         this.createInstallments(type, amount, description, date, categoryId, cardId, installments);
                    } else {
                         const newId = this.getNewId();
                        this.data.transactions.push({
                            id: newId,
                            type: type,
                            amount: amount,
                            description: description,
                            date: date,
                            originalDate: isFixed ? date : null,
                            categoryId: categoryId,
                            isFixed: isFixed,
                            fixedSourceId: isFixed ? newId : null,
                            paid: false,
                            paymentMethod: paymentMethod,
                            cardId: cardId,
                            installments: null,
                            purchaseId: null
                        });
                    }
                }
                
                this.saveData();
                this.showToast('Lan√ßamento salvo!', 'success');
            },

            deleteTransaction(id) {
                let transaction = this.data.transactions.find(t => t.id === id);
                if (!transaction) return;

                let confirmMsg = `Excluir "${transaction.description}" (${this.formatCurrency(transaction.amount)})?`;
                let idsToDelete = [id];

                if (transaction.purchaseId) {
                    confirmMsg = `Este lan√ßamento √© parte de uma compra parcelada. Excluir ir√° remover TODAS as ${transaction.installments.total} parcelas desta compra. Deseja continuar?`;
                    const purchaseId = transaction.purchaseId;
                    const installmentIds = this.data.transactions
                        .filter(t => t.purchaseId === purchaseId)
                        .map(t => t.id);
                    idsToDelete = installmentIds;
                
                } else if (transaction.isFixed && transaction.fixedSourceId === transaction.id) {
                     confirmMsg = "Este √© um lan√ßamento fixo original. Excluir tamb√©m remover√° todos os lan√ßamentos futuros gerados por ele. Deseja continuar?";
                     const sourceId = transaction.id;
                     const generatedIds = this.data.transactions
                        .filter(t => t.fixedSourceId === sourceId)
                        .map(t => t.id);
                     idsToDelete = generatedIds;
                }

                if (confirm(confirmMsg)) {
                    this.data.transactions = this.data.transactions.filter(t => !idsToDelete.includes(t.id));
                    this.saveData();
                    this.showToast('Lan√ßamento(s) exclu√≠do(s)!', 'success');
                }
            },
            
            toggleTransactionPaid(id) {
                 const transaction = this.data.transactions.find(t => t.id === id && t.type === 'expense');
                 if (transaction) {
                     transaction.paid = !transaction.paid;
                     this.saveData();
                 }
            },

            createInstallments(type, amount, description, date, categoryId, cardId, installments) {
                const purchaseId = this.getNewId();
                const installmentAmount = Math.floor((amount / installments) * 100) / 100;
                let remainingAmount = amount;

                for (let i = 0; i < installments; i++) {
                    const currentAmount = (i === installments - 1) ? remainingAmount : installmentAmount;
                    remainingAmount -= currentAmount;
                    
                    const installmentDate = new Date(this.getUTCDate(date));
                    installmentDate.setUTCMonth(installmentDate.getUTCMonth() + i);
                    
                    // Corre√ß√£o para fim de m√™s (ex: 31/01 -> 28/02)
                    const originalDay = new Date(this.getUTCDate(date)).getUTCDate();
                    if (installmentDate.getUTCDate() !== originalDay) {
                         installmentDate.setUTCDate(0); // Vai para o √∫ltimo dia do m√™s anterior (que √© o m√™s da parcela)
                    }

                    this.data.transactions.push({
                        id: this.getNewId(),
                        type: type,
                        amount: currentAmount,
                        description: `${description} (${i + 1}/${installments})`,
                        date: this.getISODate(installmentDate),
                        originalDate: null,
                        categoryId: categoryId,
                        isFixed: false,
                        paid: false,
                        paymentMethod: 'card',
                        cardId: cardId,
                        purchaseId: purchaseId,
                        installments: {
                            current: i + 1,
                            total: installments
                        }
                    });
                }
            },
            
             generateRecurringTransactions() {
                const now = new Date();
                const currentMonth = now.getUTCMonth();
                const currentYear = now.getUTCFullYear();
                
                const fixedTransactions = this.data.transactions.filter(t => t.isFixed && t.fixedSourceId === t.id);
                let requiresSave = false;

                fixedTransactions.forEach(original => {
                    const originalDate = new Date(original.originalDate);
                    if (isNaN(originalDate.getTime())) return; // Pula se data original for inv√°lida
                    
                    // N√£o gera se o lan√ßamento original for do m√™s/ano atual
                    if (originalDate.getUTCMonth() === currentMonth && originalDate.getUTCFullYear() === currentYear) {
                        return;
                    }

                    // Verifica se j√° existe um lan√ßamento gerado para este m√™s
                    const alreadyExists = this.data.transactions.some(t => {
                         if (t.fixedSourceId !== original.id) return false;
                         const tDate = new Date(t.date);
                         if (isNaN(tDate.getTime())) return false;
                         return tDate.getUTCMonth() === currentMonth && tDate.getUTCFullYear() === currentYear;
                    });

                    if (alreadyExists) {
                        return;
                    }

                    // Se n√£o existe, cria o lan√ßamento para o m√™s atual
                    const newDate = this.getNextDueDate(originalDate.getUTCDate(), currentMonth, currentYear);
                    
                    const newGeneratedTransaction = {
                        ...original,
                        id: this.getNewId(),
                        date: newDate,
                        paid: false, // Lan√ßamentos futuros s√£o sempre "n√£o pagos"
                        fixedSourceId: original.id, // Linka ao original
                        purchaseId: null, // N√£o √© mais uma parcela
                        installments: null
                    };
                    
                    this.data.transactions.push(newGeneratedTransaction);
                    requiresSave = true;
                    console.log("Gerando lan√ßamento fixo:", newGeneratedTransaction.description);
                });
                
                if (requiresSave) {
                    this.saveData(true);
                }
            },

            // =================================================================================
            // Se√ß√£o: Cart√µes de Cr√©dito (Cards)
            // =================================================================================

            renderCards() {
                const listEl = document.getElementById('cards-list');
                if (this.data.cards.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-sm text-slate-500 dark:text-slate-400 py-8">Nenhum cart√£o cadastrado.</p>`;
                    return;
                }

                const now = new Date();
                const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); // Zera horas e usa UTC
                const currentMonth = now.getUTCMonth();
                const currentYear = now.getUTCFullYear();
                
                listEl.innerHTML = this.data.cards
                    .sort((a,b) => a.name.localeCompare(b.name))
                    .map(card => {
                    
                    // Data de Fechamento (ex: dia 25)
                    const closeDate = new Date(Date.UTC(currentYear, currentMonth, card.closeDay));
                    // Data de Vencimento (ex: dia 05)
                    const dueDate = new Date(Date.UTC(currentYear, currentMonth, card.dueDay));

                    let invoiceMonth, invoiceYear, closeMonth, closeYear, dueMonth, dueYear;

                    if (today > closeDate) {
                        // Fatura atual j√° fechou, estamos olhando para o pr√≥ximo vencimento
                        // Vencimento √© no pr√≥ximo m√™s
                        dueMonth = (currentMonth + 1) % 12;
                        dueYear = (currentMonth + 1 > 11) ? currentYear + 1 : currentYear;
                        
                        // O fechamento relevante √© o do m√™s atual
                        closeMonth = currentMonth;
                        closeYear = currentYear;
                        
                        // Fatura se refere ao m√™s que vem
                        invoiceMonth = dueMonth;
                        invoiceYear = dueYear;

                    } else {
                        // Fatura atual ainda aberta
                        // Vencimento √© este m√™s
                        dueMonth = currentMonth;
                        dueYear = currentYear;
                        
                        // O fechamento relevante √© o do m√™s anterior
                        closeMonth = (currentMonth - 1 < 0) ? 11 : currentMonth - 1;
                        closeYear = (currentMonth - 1 < 0) ? currentYear - 1 : currentYear;
                        
                        // Fatura se refere a este m√™s
                        invoiceMonth = dueMonth;
                        invoiceYear = dueYear;
                    }
                    
                     if(card.closeDay >= card.dueDay) {
                         // Vencimento (ex: 05) √© ANTES do Fechamento (ex: 25) (Ex: Nubank)
                         // Vencimento 05/11. Fechamento 25/10.
                         // Se hoje (03/11) for < Vencimento (05/11) -> Fatura √© 05/11
                         // Se hoje (06/11) for > Vencimento (05/11) -> Fatura √© 05/12
                         
                         if(today.getUTCDate() > card.dueDay) {
                            // J√° passou o vencimento deste m√™s, olhamos pro pr√≥ximo
                             invoiceMonth = (currentMonth + 1) % 12;
                             invoiceYear = (currentMonth + 1 > 11) ? currentYear + 1 : currentYear;
                             
                             closeMonth = currentMonth;
                             closeYear = currentYear;
                         
                         } else {
                             // Vencimento deste m√™s ainda n√£o chegou
                             invoiceMonth = currentMonth;
                             invoiceYear = currentYear;
                             
                             closeMonth = (currentMonth - 1 < 0) ? 11 : currentMonth - 1;
                             closeYear = (currentMonth - 1 < 0) ? currentYear - 1 : currentYear;
                         }

                     } else {
                         // Vencimento (ex: 15) √© DEPOIS do Fechamento (ex: 05) (Ex: Inter)
                         // Vencimento 15/11. Fechamento 05/11.
                         // Se hoje (03/11) for < Fechamento (05/11) -> Fatura √© 15/11 (fechamento 05/11)
                         // Se hoje (06/11) for > Fechamento (05/11) -> Fatura √© 15/11 (fechamento 05/11)
                         // Se hoje (16/11) for > Vencimento (15/11) -> Fatura √© 15/12 (fechamento 05/12)
                         
                         if(today.getUTCDate() > card.dueDay) {
                             // J√° passou vencimento, olhamos pro pr√≥ximo
                             invoiceMonth = (currentMonth + 1) % 12;
                             invoiceYear = (currentMonth + 1 > 11) ? currentYear + 1 : currentYear;
                             
                             closeMonth = (currentMonth + 1) % 12; // Fechamento √© no m√™s do vencimento
                             closeYear = (currentMonth + 1 > 11) ? currentYear + 1 : currentYear;

                         } else {
                             // Vencimento deste m√™s
                             invoiceMonth = currentMonth;
                             invoiceYear = currentYear;
                             
                             closeMonth = currentMonth; // Fechamento √© no m√™s do vencimento
                             closeYear = currentYear;
                         }
                     }
                    
                    // Data final de fechamento e vencimento
                    const finalDueDate = new Date(Date.UTC(invoiceYear, invoiceMonth, card.dueDay));
                    let finalCloseDate;

                    if(card.closeDay >= card.dueDay) {
                         // Fechamento √© no m√™s anterior ao vencimento
                         const closeInvMonth = (invoiceMonth - 1 < 0) ? 11 : invoiceMonth - 1;
                         const closeInvYear = (invoiceMonth - 1 < 0) ? invoiceYear - 1 : invoiceYear;
                         finalCloseDate = new Date(Date.UTC(closeInvYear, closeInvMonth, card.closeDay));
                    } else {
                        // Fechamento √© no mesmo m√™s do vencimento
                         finalCloseDate = new Date(Date.UTC(invoiceYear, invoiceMonth, card.closeDay));
                    }
                    
                    const invoiceStartDate = new Date(finalCloseDate);
                    invoiceStartDate.setUTCDate(invoiceStartDate.getUTCDate() + 1);
                    invoiceStartDate.setUTCMonth(invoiceStartDate.getUTCMonth() - 1);
                    
                    const invoiceEndDate = finalCloseDate;

                    const getTransactions = (startDate, endDate) => {
                        return this.data.transactions.filter(t => {
                            if (t.cardId !== card.id) return false;
                            const tDate = new Date(t.date); // Datas j√° est√£o em UTC
                             if (isNaN(tDate.getTime())) return false; 
                             
                            return tDate >= startDate && tDate <= endDate;
                        });
                    };

                    const currentInvoiceTransactions = getTransactions(invoiceStartDate, invoiceEndDate);
                    const currentInvoiceTotal = currentInvoiceTransactions.reduce((sum, t) => sum + t.amount, 0);

                    const nextInvoiceStartDate = new Date(invoiceEndDate);
                    nextInvoiceStartDate.setUTCDate(nextInvoiceStartDate.getUTCDate() + 1);
                    
                    const nextInvoiceEndDate = new Date(nextInvoiceStartDate);
                    nextInvoiceEndDate.setUTCMonth(nextInvoiceEndDate.getUTCMonth() + 1);
                    
                    const openInvoiceTransactions = getTransactions(nextInvoiceStartDate, nextInvoiceEndDate);
                    const openInvoiceTotal = openInvoiceTransactions.reduce((sum, t) => sum + t.amount, 0);
                    
                    const currentIds = currentInvoiceTransactions.map(t=>t.id);
                    const openIds = openInvoiceTransactions.map(t=>t.id);

                    const dueStr = finalDueDate.toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit' });
                    const closeStr = finalCloseDate.toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit' });

                    return `
                    <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg shadow space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-blue-600 dark:text-blue-400">${card.name}</h3>
                            <button onclick="App.showCardModal('${card.id}')" class="p-1 text-slate-500 hover:text-blue-500">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center cursor-pointer" onclick="App.showCardStatementModal('${card.name}', 'Fatura Fechada (Venc. ${dueStr})', [${currentIds.map(id => `'${id}'`)}])">
                                <div>
                                    <p class="text-sm font-semibold">Fatura Fechada (Venc. ${dueStr})</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Fechamento em ${closeStr}</p>
                                </div>
                                <p class="text-lg font-bold text-red-600 dark:text-red-400">${this.formatCurrency(currentInvoiceTotal)}</p>
                            </div>
                        </div>
                        
                         <div>
                            <div class="flex justify-between items-center cursor-pointer" onclick="App.showCardStatementModal('${card.name}', 'Fatura Aberta (Pr√≥xima)', [${openIds.map(id => `'${id}'`)}])">
                                <div>
                                    <p class="text-sm font-semibold">Fatura Aberta (Pr√≥xima)</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Parcial</p>
                                </div>
                                <p class="text-lg font-bold text-slate-600 dark:text-slate-300">${this.formatCurrency(openInvoiceTotal)}</p>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
                
                lucide.createIcons();
            },
            
            showCardModal(id) {
                const card = id ? this.data.cards.find(c => c.id === id) : null;
                const isEditing = !!card;
                
                const dayOptions = (selected) => {
                    let opts = '';
                    for(let i=1; i <= 31; i++) {
                        opts += `<option value="${i}" ${selected == i ? 'selected' : ''}>Dia ${i}</option>`;
                    }
                    return opts;
                };

                const modalHTML = `
                <form id="card-form" class="space-y-4">
                    <div class="flex items-center justify-between">
                         <h3 class="text-xl font-bold">${isEditing ? 'Editar' : 'Novo'} Cart√£o</h3>
                         <button type="button" class="close-modal-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                    </div>
                    <input type="hidden" name="id" value="${card?.id || ''}">
                    <div>
                        <label class="text-sm font-medium">Nome do Cart√£o (Ex: Nubank)</label>
                        <input type="text" name="name" maxlength="100" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${card?.name || ''}" required>
                    </div>
                     <div>
                        <label class="text-sm font-medium">Dia do Vencimento</label>
                        <select name="dueDay" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                           ${dayOptions(card?.dueDay)}
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium">Dia do Fechamento da Fatura</label>
                        <select name="closeDay" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                            ${dayOptions(card?.closeDay)}
                        </select>
                         <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Geralmente 7-10 dias antes do vencimento.</p>
                    </div>

                    <div class="flex gap-2 pt-4">
                        ${isEditing ? `<button type="button" onclick="App.deleteCard('${card.id}')" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg">Excluir</button>` : ''}
                        <button type="submit" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex-1">Salvar</button>
                    </div>
                </form>
                `;
                
                this.showModal(modalHTML);
                
                document.getElementById('card-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const id = formData.get('id') || null;
                    const name = formData.get('name');
                    const dueDay = parseInt(formData.get('dueDay'));
                    const closeDay = parseInt(formData.get('closeDay'));

                    if(dueDay === closeDay) {
                        this.showToast('Dia do vencimento e fechamento n√£o podem ser iguais', 'error');
                        return;
                    }
                    
                    const isDuplicateName = this.data.cards.some(c => c.name.toLowerCase() === name.toLowerCase() && c.id !== id);
                     if (isDuplicateName) {
                        this.showToast('J√° existe um cart√£o com este nome', 'error');
                        return;
                    }

                    const newCardData = {
                        id: id || this.getNewId(),
                        name: name,
                        dueDay: dueDay,
                        closeDay: closeDay,
                    };

                    if(id) { // Edit
                        const index = this.data.cards.findIndex(c => c.id === id);
                        this.data.cards[index] = newCardData;
                    } else { // New
                        this.data.cards.push(newCardData);
                    }
                    
                    this.saveData();
                    this.showToast('Cart√£o salvo!', 'success');
                    document.getElementById('modal').click();
                });
            },
            
            showCardStatementModal(cardName, title, transactionIds) {
                const transactions = this.data.transactions
                    .filter(t => transactionIds.includes(t.id))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                let transactionsHTML = '';
                if (transactions.length === 0) {
                    transactionsHTML = `<p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">Nenhum lan√ßamento nesta fatura.</p>`;
                } else {
                    transactionsHTML = transactions.map(t => {
                         // Trata data inv√°lida na exibi√ß√£o
                        const dateObj = new Date(t.date);
                        const dateStr = !isNaN(dateObj.getTime()) ? dateObj.toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'Data inv√°lida';
                        
                        return `
                        <div class="flex items-center justify-between py-2 border-b dark:border-slate-700">
                            <div class="flex-1 min-w-0 mr-2">
                                <p class="font-medium truncate">${t.description}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${dateStr}</p>
                            </div>
                            <p class="font-bold text-red-600 dark:text-red-400">${this.formatCurrency(t.amount)}</p>
                        </div>
                        `
                    }).join('');
                }

                const total = transactions.reduce((sum, t) => sum + t.amount, 0);

                const modalHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                         <h3 class="text-xl font-bold">${cardName}</h3>
                         <button type="button" class="close-modal-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-600 dark:text-slate-300">${title}</p>
                        <p class="text-2xl font-bold">${this.formatCurrency(total)}</p>
                    </div>
                    <div class="max-h-60 overflow-y-auto space-y-1 pr-2">
                       ${transactionsHTML}
                    </div>
                </div>
                `;
                this.showModal(modalHTML);
            },

            deleteCard(id) {
                const isUsed = this.data.transactions.some(t => t.cardId === id);
                if (isUsed) {
                    this.showToast("N√£o √© poss√≠vel excluir. Cart√£o em uso. Mude os lan√ßamentos primeiro.", 'error');
                    return;
                }
                if (confirm("Tem certeza que deseja excluir este cart√£o?")) {
                    this.data.cards = this.data.cards.filter(c => c.id !== id);
                    this.saveData();
                    this.showToast('Cart√£o exclu√≠do!', 'success');
                    document.getElementById('modal').click();
                }
            },


            // =================================================================================
            // Se√ß√£o: Metas (Goals)
            // =================================================================================
            
            renderGoals() {
                const listEl = document.getElementById('goals-list');
                 if (this.data.goals.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-sm text-slate-500 dark:text-slate-400 py-8">Nenhuma meta criada.</p>`;
                    return;
                }
                
                 listEl.innerHTML = this.data.goals
                    .sort((a,b) => (a.saved / a.target) - (b.saved / b.target)) // Ordena por % conclu√≠da
                    .map(goal => {
                    const progress = (goal.target > 0) ? Math.min(100, (goal.saved / goal.target) * 100) : 0;
                    
                    return `
                    <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg shadow space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold">${goal.name}</h3>
                            <button onclick="App.showGoalModal('${goal.id}')" class="p-1 text-slate-500 hover:text-blue-500">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                         <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4">
                            <div class="bg-blue-500 h-4 rounded-full text-white text-xs font-bold flex items-center justify-center" style="width: ${progress}%">
                                ${progress > 15 ? `${progress.toFixed(0)}%` : ''}
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center text-sm">
                             <span class="font-medium text-slate-600 dark:text-slate-300">Guardado: <span class="text-green-600 dark:text-green-400">${this.formatCurrency(goal.saved)}</span></span>
                             <span class="font-bold">Alvo: ${this.formatCurrency(goal.target)}</span>
                        </div>
                        
                         <div class="flex gap-2 pt-2">
                             <button onclick="App.showGoalDepositModal('${goal.id}', 'add')" class="bg-green-500 text-white w-full text-sm font-semibold py-1 px-3 rounded-lg">Adicionar</button>
                             <button onclick="App.showGoalDepositModal('${goal.id}', 'remove')" class="bg-yellow-500 text-white w-full text-sm font-semibold py-1 px-3 rounded-lg">Retirar</button>
                        </div>
                    </div>
                    `;
                }).join('');
                
                lucide.createIcons();
            },
            
            showGoalModal(id) {
                 const goal = id ? this.data.goals.find(g => g.id === id) : null;
                const isEditing = !!goal;

                const modalHTML = `
                <form id="goal-form" class="space-y-4">
                    <div class="flex items-center justify-between">
                         <h3 class="text-xl font-bold">${isEditing ? 'Editar' : 'Nova'} Meta</h3>
                         <button type="button" class="close-modal-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                    </div>
                    <input type="hidden" name="id" value="${goal?.id || ''}">
                    <input type="hidden" name="saved" value="${goal?.saved || 0}">
                    <div>
                        <label class="text-sm font-medium">Nome da Meta</label>
                        <input type="text" name="name" maxlength="100" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${goal?.name || ''}" required>
                    </div>
                     <div>
                        <label class="text-sm font-medium">Valor Alvo (R$)</label>
                        <input type="text" name="target" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${this.formatCurrency(goal?.target)}" oninput="App.autoFormatCurrency(this)" required>
                    </div>

                    <div class="flex gap-2 pt-4">
                        ${isEditing ? `<button type="button" onclick="App.deleteGoal('${goal.id}')" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg">Excluir</button>` : ''}
                        <button type="submit" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex-1">Salvar</button>
                    </div>
                </form>
                `;
                this.showModal(modalHTML);
                
                document.getElementById('goal-form').addEventListener('submit', (e) => {
                     e.preventDefault();
                    const formData = new FormData(e.target);
                    const id = formData.get('id') || null;
                    const target = this.parseCurrency(formData.get('target'));
                    
                    if (target <= 0) {
                         this.showToast('O valor alvo deve ser maior que zero', 'error');
                         return;
                    }
                    
                    const newGoalData = {
                        id: id || this.getNewId(),
                        name: formData.get('name'),
                        target: target,
                        saved: parseFloat(formData.get('saved')) || 0,
                    };

                    if(id) { // Edit
                        const index = this.data.goals.findIndex(c => c.id === id);
                        this.data.goals[index] = newGoalData;
                    } else { // New
                        this.data.goals.push(newGoalData);
                    }
                    
                    this.saveData();
                    this.showToast('Meta salva!', 'success');
                    document.getElementById('modal').click();
                });
            },
            
            deleteGoal(id) {
                 if (confirm("Tem certeza que deseja excluir esta meta?")) {
                    this.data.goals = this.data.goals.filter(c => c.id !== id);
                    this.saveData();
                    this.showToast('Meta exclu√≠da!', 'success');
                    document.getElementById('modal').click();
                }
            },
            
            showGoalDepositModal(goalId, type) {
                const goal = this.data.goals.find(g => g.id === goalId);
                if (!goal) return;
                
                const isAdd = type === 'add';
                const title = isAdd ? 'Adicionar √† Meta' : 'Retirar da Meta';
                const btnText = isAdd ? 'Adicionar' : 'Retirar';
                const btnColor = isAdd ? 'bg-green-500' : 'bg-yellow-500';

                const modalHTML = `
                 <form id="goal-deposit-form" class="space-y-4">
                    <div class="flex items-center justify-between">
                         <h3 class="text-xl font-bold">${title}</h3>
                         <button type="button" class="close-modal-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                    </div>
                    <p class="text-sm">Meta: <strong>${goal.name}</strong></p>
                    <p class="text-sm">Salvo: <strong>${this.formatCurrency(goal.saved)}</strong></p>
                    <input type="hidden" name="goalId" value="${goalId}">
                    <input type="hidden" name="type" value="${type}">
                    <div>
                        <label class="text-sm font-medium">Valor (R$)</label>
                        <input type="text" name="amount" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="" oninput="App.autoFormatCurrency(this)" required>
                    </div>
                    <div class="flex pt-4">
                        <button type="submit" class="${btnColor} text-white font-semibold py-2 px-4 rounded-lg flex-1">${btnText}</button>
                    </div>
                </form>
                `;
                this.showModal(modalHTML);
                
                document.getElementById('goal-deposit-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const amount = this.parseCurrency(formData.get('amount'));
                    
                    if (amount <= 0) {
                         this.showToast('O valor deve ser maior que zero', 'error');
                         return;
                    }
                    
                    if(type === 'add') {
                        goal.saved += amount;
                    } else {
                        goal.saved -= amount;
                        if (goal.saved < 0) goal.saved = 0;
                    }
                    
                    this.saveData();
                    this.showToast('Valor atualizado na meta', 'success');
                    document.getElementById('modal').click();
                });
            },

            // =================================================================================
            // Se√ß√£o: Configura√ß√µes (Settings)
            // =================================================================================

            renderSettings() {
                const expList = document.getElementById('expense-categories-list');
                expList.innerHTML = this.data.categories.expense
                    .sort((a,b) => a.name.localeCompare(b.name))
                    .map(c => `
                    <div class="flex justify-between items-center text-sm p-2 bg-slate-50 dark:bg-slate-900/50 rounded">
                        <span class="flex items-center gap-2">
                            ${c.color ? `<span class="w-4 h-4 rounded-full" style="background-color: ${c.color}"></span>` : ''}
                            ${c.name}
                        </span>
                        ${c.id === '0' ? 
                            '<i data-lucide="lock" class="w-4 h-4 text-slate-400" title="Categoria padr√£o"></i>' : 
                            `<button onclick="App.showCategoryModal('expense', '${c.id}')" class="p-1 text-slate-500 hover:text-blue-500">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>` 
                        }
                    </div>
                `).join('');
                
                const incList = document.getElementById('income-categories-list');
                incList.innerHTML = this.data.categories.income
                    .sort((a,b) => a.name.localeCompare(b.name))
                    .map(c => `
                     <div class="flex justify-between items-center text-sm p-2 bg-slate-50 dark:bg-slate-900/50 rounded">
                        <span>${c.name}</span>
                         ${c.id === '100' ? 
                            '<i data-lucide="lock" class="w-4 h-4 text-slate-400" title="Categoria padr√£o"></i>' : 
                            `<button onclick="App.showCategoryModal('income', '${c.id}')" class="p-1 text-slate-500 hover:text-blue-500">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>` 
                        }
                    </div>
                `).join('');
                
                // Popula selects de relat√≥rio
                const reportMonthSelect = document.getElementById('report-month');
                const reportYearSelect = document.getElementById('report-year');
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                if (reportMonthSelect.options.length <= 1) {
                    const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    reportMonthSelect.innerHTML = months.map((month, index) => `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${month}</option>`).join('');
                    
                     let yearsHTML = '';
                     for (let y = currentYear + 1; y >= currentYear - 5; y--) {
                        yearsHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
                     }
                     reportYearSelect.innerHTML = yearsHTML;
                }
                
                lucide.createIcons();
            },
            
            // ### MODIFICADO 3: Adiciona input de cor ao modal
            showCategoryModal(type, id) {
                 const category = id ? this.data.categories[type].find(c => c.id === id) : null;
                 const isEditing = !!category;

                 const modalHTML = `
                 <form id="category-form" class="space-y-4">
                    <div class="flex items-center justify-between">
                         <h3 class="text-xl font-bold">${isEditing ? 'Editar' : 'Nova'} Categoria</h3>
                         <button type="button" class="close-modal-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                    </div>
                    <input type="hidden" name="id" value="${category?.id || ''}">
                    <input type="hidden" name="type" value="${type}">
                    
                    <div>
                        <label class="text-sm font-medium">Nome</label>
                        <input type="text" name="name" maxlength="100" class="w-full mt-1 p-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${category?.name || ''}" required>
                    </div>
                    
                    ${type === 'expense' ? `
                    <div>
                        <label class="text-sm font-medium">Cor</label>
                        <input type="color" name="color" class="w-full mt-1 p-1 h-10 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" value="${category?.color || '#ef4444'}" required>
                    </div>
                    ` : ''}
                    <div class="flex gap-2 pt-4">
                        ${isEditing ? `<button type="button" onclick="App.deleteCategory('${type}', '${category.id}')" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg">Excluir</button>` : ''}
                        <button type="submit" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex-1">Salvar</button>
                    </div>
                </form>
                `;
                this.showModal(modalHTML);
                
                // ### MODIFICADO 4: Atualiza l√≥gica de salvamento
                document.getElementById('category-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const id = formData.get('id') || null;
                    const type = formData.get('type');
                    
                    const newCategoryData = {
                        id: id || this.getNewId(),
                        name: formData.get('name'),
                    };
                    
                    // Adiciona a cor se for categoria de despesa
                    if (type === 'expense') {
                        newCategoryData.color = formData.get('color');
                    }

                    if(id) { // Edit
                        const index = this.data.categories[type].findIndex(c => c.id === id);
                        this.data.categories[type][index] = newCategoryData;
                    } else { // New
                        this.data.categories[type].push(newCategoryData);
                    }
                    
                    this.saveData();
                    this.showToast('Categoria salva!', 'success');
                    document.getElementById('modal').click();
                });
            },
            
            deleteCategory(type, id) {
                 if(id === '100' || id === '0') {
                     this.showToast("Categorias padr√£o n√£o podem ser exclu√≠das.", 'error');
                     return;
                 }
                 
                 const isUsed = this.data.transactions.some(t => t.categoryId === id && t.type === type);
                 if (isUsed) {
                    this.showToast("N√£o √© poss√≠vel excluir. Categoria em uso. Mude os lan√ßamentos de categoria primeiro.", 'error');
                    return;
                }
                 
                 if (confirm("Tem certeza que deseja excluir esta categoria?")) {
                    this.data.categories[type] = this.data.categories[type].filter(c => c.id !== id);
                    this.saveData();
                    this.showToast('Categoria exclu√≠da!', 'success');
                    document.getElementById('modal').click();
                }
            },
            
            // =================================================================================
            // Se√ß√£o: Import/Export e Relat√≥rios
            // =================================================================================

            exportData() {
                try {
                    const dataStr = JSON.stringify(this.data);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const a = document.createElement('a');
                    a.href = dataUri;
                    a.download = `fin-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    this.showToast('Backup exportado com sucesso!', 'success');
                } catch(e) {
                     this.showToast('Erro ao exportar dados', 'error');
                     console.error(e);
                }
            },
            
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm("IMPORTANTE: A importa√ß√£o ir√° SOBRESCREVER todos os dados atuais. Deseja continuar?")) {
                    event.target.value = null; // Limpa o input
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Valida√ß√£o b√°sica
                        if (importedData.transactions && importedData.categories) {
                            this.data = importedData;
                            this.saveData(); // Salva e atualiza
                            this.showToast('Dados importados com sucesso!', 'success');
                             event.target.value = null; // Limpa o input
                        } else {
                            throw new Error('Arquivo JSON inv√°lido ou incompleto.');
                        }
                    } catch (err) {
                        this.showToast(`Erro ao importar: ${err.message}`, 'error');
                         event.target.value = null; // Limpa o input
                    }
                };
                reader.onerror = () => {
                     this.showToast('Erro ao ler o arquivo.', 'error');
                      event.target.value = null; // Limpa o input
                };
                reader.readAsText(file);
            },
            
             renderReport() {
                 this.showLoading(true);
                 const outputEl = document.getElementById('report-output');
                 
                 const month = parseInt(document.getElementById('report-month').value);
                 const year = parseInt(document.getElementById('report-year').value);
                 const monthName = document.getElementById('report-month').options[document.getElementById('report-month').selectedIndex].text;
                 
                 const mealVoucherCategoryId = '100';

                 const reportTransactions = this.data.transactions.filter(t => {
                     const date = new Date(t.date);
                     if (isNaN(date.getTime())) return false; 
                     return date.getUTCMonth() === month && date.getUTCFullYear() === year;
                 });

                 // --- C√°lculos ---
                 const totalIncome = reportTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                 const totalVRIncome = reportTransactions.filter(t => t.type === 'income' && t.categoryId === mealVoucherCategoryId).reduce((sum, t) => sum + t.amount, 0);
                 const totalOtherIncome = totalIncome - totalVRIncome;
                 
                 const totalExpense = reportTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                 const totalVRExpense = reportTransactions.filter(t => t.type === 'expense' && t.paymentMethod === 'meal_voucher').reduce((sum, t) => sum + t.amount, 0);
                 const totalOtherExpense = totalExpense - totalVRExpense;
                 
                 const finalBalance = totalOtherIncome - totalOtherExpense;
                 
                 const getCategorySummary = (type) => {
                     const categories = (type === 'income' ? this.data.categories.income : this.data.categories.expense);
                     
                     const summary = reportTransactions
                         .filter(t => t.type === type)
                         .filter(t => { // Exclui VR dos relat√≥rios de categoria
                             if (type === 'income' && t.categoryId === mealVoucherCategoryId) return false;
                             if (type === 'expense' && t.paymentMethod === 'meal_voucher') return false;
                             return true;
                         })
                         .reduce((acc, t) => {
                             const category = this.getCategoryById(type, t.categoryId);
                             const name = category ? category.name : 'Sem Categoria';
                             acc[name] = (acc[name] || 0) + t.amount;
                             return acc;
                         }, {});
                         
                     return Object.entries(summary)
                         .sort(([, a], [, b]) => b - a) // Ordena por valor (maior primeiro)
                         .map(([name, amount]) => `
                             <div class="flex justify-between text-sm py-1 border-b dark:border-slate-700">
                                 <span class="text-slate-600 dark:text-slate-300">${name}</span>
                                 <span class="font-medium">${this.formatCurrency(amount)}</span>
                             </div>
                         `).join('') || null;
                 };

                const incomeSummary = getCategorySummary('income');
                const expenseSummary = getCategorySummary('expense');

                 // --- HTML ---
                 const reportHTML = `
                 <div id="pdf-content-wrapper" class="p-4 space-y-6">
                     <div class="flex justify-between items-center">
                         <div>
                             <h4 class="text-2xl font-bold">Relat√≥rio Mensal</h4>
                             <p class="text-lg font-semibold text-blue-600 dark:text-blue-400">${monthName} de ${year}</p>
                         </div>
                         <button id="download-pdf-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                             <i data-lucide="file-down" class="w-4 h-4"></i> PDF
                         </button>
                     </div>
                     
                     <section class="border rounded-lg p-4" style="border-color: #e2e8f0;">
                         <h5 class="font-bold text-lg mb-3">Resumo (Contas)</h5>
                         <div class="space-y-2">
                             <div class="flex justify-between items-center text-lg">
                                 <span class="text-green-600 dark:text-green-400">Receitas (Outras):</span>
                                 <span class="font-bold text-green-600 dark:text-green-400">${this.formatCurrency(totalOtherIncome)}</span>
                             </div>
                             <div class="flex justify-between items-center text-lg">
                                 <span class="text-red-600 dark:text-red-400">Despesas (Contas):</span>
                                 <span class="font-bold text-red-600 dark:text-red-400">-${this.formatCurrency(totalOtherExpense)}</span>
                             </div>
                             <div class="flex justify-between items-center text-xl pt-2 border-t mt-2">
                                 <span class="font-bold">Saldo do M√™s:</span>
                                 <span class="font-bold ${finalBalance >= 0 ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}">${this.formatCurrency(finalBalance)}</span>
                             </div>
                         </div>
                     </section>
                     
                      <section class="border rounded-lg p-4" style="border-color: #e2e8f0;">
                         <h5 class="font-bold text-lg mb-3">Resumo (Vale Refei√ß√£o)</h5>
                         <div class="space-y-2">
                             <div class="flex justify-between items-center text-md">
                                 <span class="text-green-600 dark:text-green-400">Cr√©dito VR:</span>
                                 <span class="font-medium text-green-600 dark:text-green-400">${this.formatCurrency(totalVRIncome)}</span>
                             </div>
                             <div class="flex justify-between items-center text-md">
                                 <span class="text-red-600 dark:text-red-400">Gasto VR:</span>
                                 <span class="font-medium text-red-600 dark:text-red-400">-${this.formatCurrency(totalVRExpense)}</span>
                             </div>
                             <div class="flex justify-between items-center text-lg pt-2 border-t mt-2">
                                 <span class="font-bold text-yellow-700 dark:text-yellow-500">Saldo VR (M√™s):</span>
                                 <span class="font-bold text-yellow-700 dark:text-yellow-500">${this.formatCurrency(totalVRIncome - totalVRExpense)}</span>
                             </div>
                         </div>
                     </section>
                     
                     <section class="border rounded-lg p-4" style="border-color: #e2e8f0;">
                         <h5 class="font-bold text-lg mb-3">Despesas por Categoria (Exclui VR)</h5>
                         ${expenseSummary || '<p class="text-sm">Nenhuma despesa registrada.</p>'}
                     </section>
                     
                     <section class="border rounded-lg p-4" style="border-color: #e2e8f0;">
                         <h5 class="font-bold text-lg mb-3">Receitas por Categoria (Exclui VR)</h5>
                         ${incomeSummary || '<p class="text-sm">Nenhuma receita registrada.</p>'}
                     </section>
                 </div>
                 `;
                 
                 outputEl.innerHTML = reportHTML;
                 outputEl.classList.remove('hidden');
                 lucide.createIcons();
                 
                document.getElementById('download-pdf-btn').addEventListener('click', () => {
                    this.showLoading(true);
                    const { jsPDF } = window.jspdf;
                    const pdfContentWrapper = document.getElementById('pdf-content-wrapper');
                    
                    // For√ßa fundo branco e texto preto para o PDF
                    pdfContentWrapper.style.backgroundColor = 'white';
                    pdfContentWrapper.style.color = 'black';
                    
                    html2canvas(pdfContentWrapper, { scale: 2 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        
                        const imgProps = pdf.getImageProperties(imgData);
                        const imgWidth = pdfWidth - 20; // margem 10mm
                        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                        
                        let heightLeft = imgHeight;
                        let position = 10;

                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= (pdf.internal.pageSize.getHeight() - 20); // subtrai altura da pagina com margem

                        while (heightLeft > 0) {
                            position = heightLeft - imgHeight + 10; // recalcula posi√ß√£o negativa
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                            heightLeft -= (pdf.internal.pageSize.getHeight() - 20);
                        }
                        
                        pdf.save(`relatorio-fin-${month+1}-${year}.pdf`);
                        this.showLoading(false);
                        this.showToast('Relat√≥rio PDF gerado!', 'success');
                        
                         // Restaura estilos
                         pdfContentWrapper.style.backgroundColor = '';
                         pdfContentWrapper.style.color = '';
                         
                    }).catch(err => {
                         this.showLoading(false);
                         this.showToast('Erro ao gerar PDF', 'error');
                         console.error("Erro no html2canvas:", err);
                    });
                });
                 
                 this.showLoading(false);
            },
            
        };

        // Inicia a aplica√ß√£o
        App.init();
    });
    </script>
</body>
</html>
